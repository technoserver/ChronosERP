<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:erp="http://java.sun.com/jsf/composite/components">


    <h:panelGroup layout="block" id="outputPanelDetalhe">
        <h:panelGroup layout="block" rendered="#{!orcamentoCabecalhoControll.telaGrid}">

            <h:panelGroup layout="block" id="panelCentroDetalhe">
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-12">

                            <h:panelGroup layout="block" id="panelValores" styleClass="row">

                                <div class="col-lg-4 col-xs-6">
                                    <!-- small box -->
                                    <div class="small-box bg-gray">
                                        <div class="inner">
                                            <h3>R$
                                                <span>
                                                        <h:outputText
                                                                value="#{orcamentoCabecalhoControll.objeto.valorTotal}">
                                                            <f:convertNumber pattern="#,##0.00"/>
                                                        </h:outputText>
                                                    </span>
                                            </h3>

                                            <p>Valor Total</p>
                                        </div>
                                        <div class="icon" style="top: 0px">
                                            <i class="fa  fa-money"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-xs-6">
                                    <!-- small box -->
                                    <div class="small-box bg-gray">
                                        <div class="inner">
                                            <h3>R$
                                                <span>
                                                        <h:outputText
                                                                value="#{orcamentoCabecalhoControll.objeto.valorSubtotal}">
                                                            <f:convertNumber pattern="#,##0.00"/>
                                                        </h:outputText>
                                                    </span>
                                            </h3>

                                            <p>Valor Produtos</p>
                                        </div>
                                        <div class="icon" style="top: 0px">
                                            <i class="fa fa-shopping-cart"></i>
                                        </div>
                                    </div>
                                </div>


                                <div class="col-lg-4 col-xs-6">
                                    <!-- small box -->
                                    <div class="small-box bg-gray">
                                        <div class="inner">

                                            <h3>
                                                R$
                                                <span>
                                                            <h:outputText
                                                                    value="#{orcamentoCabecalhoControll.objeto.valorDesconto}">
                                                                <f:convertNumber pattern="#,##0.00"/>
                                                            </h:outputText>
                                                        </span>
                                                <p:commandLink styleClass="btn btn-link"
                                                               title="Aplicar desconto no valor total"
                                                               update=":formOutrasTelas2:panelOutrasTelas2"
                                                               disabled="#{orcamentoCabecalhoControll.objeto.valorTotal.signum() eq 0}"
                                                               oncomplete="PF('dialogOutrasTelas2').show()">
                                                    <i class="fa fa-pencil fa-2x" aria-hidden="true"></i>
                                                </p:commandLink>

                                                <p:commandLink styleClass="btn btn-link"
                                                               title="Remover Desconto"
                                                               action="#{orcamentoCabecalhoControll.removerDesconto}"
                                                               process="@this"
                                                               update=":formCentro:growl,:formCentro:panelValores,:formCentro:tableOrcamento"
                                                               rendered="#{orcamentoCabecalhoControll.objeto.valorDesconto.signum() ne 0}">
                                                    <i class="fa fa-ban fa-2x" aria-hidden="true"></i>
                                                </p:commandLink>
                                            </h3>


                                            <p>Valor do Desconto</p>
                                        </div>
                                        <div class="icon" style="top: 0px">
                                            <i class="fa fa-percent" aria-hidden="true"></i>
                                        </div>
                                    </div>
                                </div>

                            </h:panelGroup>


                            <p:tabView id="tab-view-orcamento" style="border: 0px;" scrollable="true">
                                <p:tab title="Dados Principais" id="dados-principais">
                                    <h:form id="form-dados-pripais">
                                        <div class="row">


                                            <div class="col-xs-12 col-sm-4 col-md-4">
                                                <p:outputLabel value="Cliente" for="cliente"/>
                                                <div class="field-action">
                                                    <p:autoComplete id="cliente"
                                                                    value="#{orcamentoCabecalhoControll.objeto.cliente}"
                                                                    completeMethod="#{orcamentoCabecalhoControll.getListaCliente}"
                                                                    var="objeto" itemLabel="#{objeto.pessoa.nome}"
                                                                    itemValue="#{objeto}"
                                                                    queryDelay="500"
                                                                    style="width: 100%"
                                                                    converter="defaultConverter" forceSelection="true"
                                                                    minQueryLength="3" maxResults="10" required="true"
                                                                    emptyMessage="Nenhum registro encontrado">>


                                                    </p:autoComplete>
                                                    <div class="field-action__icon">
                                                        <p:commandLink title="Add novo cliente"
                                                                       style="font-size: 20px;color: #00acac"
                                                                       action="#{cadastroRapidoClienteControll.abrirDialog}"
                                                                       process="@this" update="@none"
                                                        >
                                                            <p:ajax event="dialogReturn"
                                                                    listener="#{orcamentoCabecalhoControll.clienteSelecionado}"
                                                                    process="@this" update="cliente"/>
                                                            <i class="fa fa-plus-circle"></i>
                                                        </p:commandLink>
                                                    </div>


                                                </div>
                                            </div>


                                            <erp:autoComplete styleClass="col-xs-12 col-sm-4 col-md-4"
                                                              label="Vendedor"
                                                              itemLabel="#{objeto.colaborador.pessoa.nome}"
                                                              controller="#{orcamentoCabecalhoControll}"
                                                              completeMethod="getListaVendedor"
                                                              nomeAtributo="#{orcamentoCabecalhoControll.objeto.vendedor}"
                                                              idComponente="vendaOrcamentoCabecalhoVendedor">
                                                <p:ajax event="itemSelecionado"
                                                        listener="#{orcamentoCabecalhoControll.definirTaxaComissao}"
                                                />
                                            </erp:autoComplete>

                                            <erp:campoData label="Entrega em"
                                                           styleClass="col-xs-12 col-sm-2 col-md-2"
                                                           idComponente="dataEntrega"
                                                           nomeAtributo="#{orcamentoCabecalhoControll.objeto.dataEntrega}"/>


                                        </div>
                                        <div class="row">
                                            <erp:campoAreaTexto styleClass="col-xs-12 col-sm-12 col-md-12"
                                                                idComponente="vendaOrcamentoCabecalhoObservacao"
                                                                label="Observacao"
                                                                nomeAtributo="#{orcamentoCabecalhoControll.objeto.observacao}"/>
                                        </div>
                                    </h:form>


                                </p:tab>

                                <p:tab title="Produtos" id="produtos">


                                    <h:form id="form-produtos">

                                        <h:panelGroup layout="block" id="container-item"
                                                      style="height: 90px;background: #e0dfdf;display: flex;align-items: center;padding: 5px">
                                            <div class="row" style="height: 100%">

                                                <h:panelGroup layout="block" class="col-xs-12 col-sm-5 col-md-5"
                                                              id="produto-selecionado">

                                                    <div style="display: flex;align-items: center; height: 100%;">
                                                        <p:autoComplete id="produto"
                                                                        value="#{orcamentoCabecalhoControll.orcamentoDetalhe.produto}"
                                                                        completeMethod="#{orcamentoCabecalhoControll.getListaProduto}"
                                                                        var="objeto"
                                                                        itemLabel="#{objeto.nome}" itemValue="#{objeto}"
                                                                        queryDelay="500"
                                                                        style="#{orcamentoCabecalhoControll.exibirGrade ? 'width: 77%':'width: 100%'}"
                                                                        placeholder="Digite o nome ou código ou código interno do Prod."
                                                                        converter="defaultConverter"
                                                                        forceSelection="true"
                                                                        minQueryLength="3"
                                                                        emptyMessage="Nenhum produto encontrado">

                                                            <p:ajax event="itemSelect" process="@this"
                                                                    update="formCentro:tab-view-orcamento:form-produtos:container-item"
                                                                    listener="#{orcamentoCabecalhoControll.definirValorVenda}"/>
                                                        </p:autoComplete>
                                                        <h:panelGroup layout="block" id="grade" style="margin-left: 5px"
                                                                      rendered="#{orcamentoCabecalhoControll.exibirGrade}">
                                                            <h:selectOneMenu styleClass="form-control grade"
                                                                             id="cor"
                                                                             value="#{orcamentoCabecalhoControll.cor}"
                                                                             converter="defaultConverter"
                                                                             required="true">
                                                                <f:selectItem itemValue="#{null}" itemLabel="COR"/>
                                                                <f:selectItems
                                                                        value="#{orcamentoCabecalhoControll.cores}"
                                                                        var="#{obj}" itemValue="#{obj}"
                                                                        itemLabel="#{obj.nome}"/>
                                                                <p:ajax process="@this" event="change"
                                                                        update="formCentro:tab-view-orcamento:form-produtos:grade"
                                                                        listener="#{orcamentoCabecalhoControll.definirTamanhos()}"/>
                                                            </h:selectOneMenu>
                                                            <h:selectOneMenu styleClass="form-control grade"
                                                                             value="#{orcamentoCabecalhoControll.tamanho}"
                                                                             converter="defaultConverter"
                                                                             required="true"
                                                                             id="tamanho">
                                                                <f:selectItem itemValue="#{null}" itemLabel="Tamanho"/>
                                                                <f:selectItems
                                                                        value="#{orcamentoCabecalhoControll.tamanhos}"
                                                                        var="#{obj}" itemValue="#{obj}"
                                                                        itemLabel="#{obj.nome}"/>
                                                            </h:selectOneMenu>
                                                        </h:panelGroup>
                                                    </div>


                                                </h:panelGroup>

                                                <erp:campoDecimal styleClass="col-xs-12 col-sm-2 col-md-2"
                                                                  idComponente="vendaOrcamentoDetalheQuantidade"
                                                                  label="Quantidade"
                                                                  requerido="true"
                                                                  nomeAtributo="#{orcamentoCabecalhoControll.orcamentoDetalhe.quantidade}"/>


                                                <erp:campoDecimal styleClass="col-xs-12 col-sm-2 col-md-2"
                                                                  idComponente="valorUnitario"
                                                                  desabilitado="#{!orcamentoCabecalhoControll.podeAlterarPreco}"
                                                                  label="Valor"
                                                                  requerido="true"
                                                                  nomeAtributo="#{orcamentoCabecalhoControll.orcamentoDetalhe.valorUnitario}"/>

                                                <div class="col-xs-12 col-sm-3 col-md-3">
                                                    <p:outputLabel value="Desconto" for="desconto"/>
                                                    <div class="ui-inputgroup">

                                                        <p:inputNumber id="desconto"
                                                                       value="#{orcamentoCabecalhoControll.desconto}"
                                                                       style="width: 100%;"
                                                                       decimalPlaces="2"
                                                                       minValue="0"/>


                                                        <p:commandButton id="btn-tipo-desconto"
                                                                         action="#{orcamentoCabecalhoControll.alterarTipoDesconto}"
                                                                         process="@this"
                                                                         update="formCentro:tab-view-orcamento:form-produtos:btn-tipo-desconto"
                                                                         value="#{orcamentoCabecalhoControll.tipoDesconto eq 0 ? '%' : 'R$' }"/>

                                                        <p:commandButton id="btn-salvar"
                                                                         style="margin-left: 5px"
                                                                         value="Incluir"
                                                                         update=":formCentro:growl,formCentro:panelValores,:formCentro:tab-view-orcamento:form-produtos:container-item,formCentro:tab-view-orcamento:itens,:formCentro:tab-view-orcamento:tipo-pagamento"
                                                                         action="#{orcamentoCabecalhoControll.salvarVendaOrcamentoDetalhe}"
                                                                         process="form-produtos"
                                                        />
                                                    </div>
                                                </div>

                                            </div>
                                        </h:panelGroup>

                                    </h:form>


                                    <p:dataTable id="itens" var="obj"
                                                 styleClass="m-t"
                                                 value="#{orcamentoCabecalhoControll.objeto.listaOrcamentoDetalhe}"
                                                 paginator="true" rows="10" rowsPerPageTemplate="10,20,30,40"
                                                 reflow="true"
                                                 rowKey="#{obj.id}" paginatorPosition="bottom">


                                        <p:column headerText="Produto">
                                            <h:outputLabel value="#{obj.produto.nome}"/>
                                        </p:column>
                                        <p:column headerText="QTD." styleClass="text-center" width="110">
                                            <h:outputLabel value="#{obj.quantidade}">
                                                <f:convertNumber pattern="0.000"/>
                                            </h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Valor UN" styleClass="text-right" width="110">
                                            <h:outputLabel value="#{obj.valorUnitario}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Subtotal" styleClass="text-right" width="150">
                                            <h:outputLabel value="#{obj.valorSubtotal}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Desc." styleClass="text-right" width="100">
                                            <h:outputLabel value="#{obj.valorDesconto}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Total" styleClass="text-right" width="200">
                                            <h:outputLabel value="#{obj.valorTotal}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Ações" width="120" styleClass="text-center">
                                            &nbsp;
                                            <p:commandLink title="Excluir"
                                                           id="btnExluirProduto"
                                                           action="#{orcamentoCabecalhoControll.excluirVendaOrcamentoDetalhe}"
                                                           style="position: relative; right: 7px"
                                                           update=":formCentro:growl,itens,:formCentro:panelValores"
                                                           process="itens"
                                                           oncomplete="atualizarMsg();"
                                                           class="btn btn-default"
                                            >
                                                <i class="fa fa-times"></i>
                                                <p:confirm header="Confirmar" message="Deseja excluir ?"/>

                                                <f:setPropertyActionListener value="#{obj}"
                                                                             target="#{orcamentoCabecalhoControll.orcamentoDetalheSelecionado}"/>
                                            </p:commandLink>
                                        </p:column>


                                    </p:dataTable>
                                </p:tab>

                                <p:tab title="Formas de pagamento" id="forma-pagamento">

                                    <h:panelGroup id="tipo-pagamento" layout="block" styleClass="row m-b">
                                        <div class="col-xs-12 col-sm-3 col-md-3">
                                            <h:selectOneMenu id="PedidoFormaPagamentoId"
                                                             value="#{orcamentoCabecalhoControll.tipoPagamento}"
                                                             class="form-control"
                                                             converter="defaultConverter">
                                                <f:selectItems value="#{orcamentoCabecalhoControll.listTipoPagamento}"
                                                               var="obj" itemValue="#{obj}"
                                                               itemLabel="#{obj.descricao}"/>

                                                <p:ajax process="@this" event="change"
                                                        update="formCentro:tab-view-orcamento:tipo-pagamento"
                                                        listener="#{orcamentoCabecalhoControll.definirCondicoess()}"/>

                                            </h:selectOneMenu>
                                        </div>

                                        <h:panelGroup layout="block" styleClass="col-xs-12 col-sm-3 col-md-3"
                                                      rendered="#{orcamentoCabecalhoControll.exibirCondicoes}">
                                            <h:selectOneMenu id="condicoesPagamento"
                                                             value="#{orcamentoCabecalhoControll.condicaoPagamento}"
                                                             class="form-control"
                                                             converter="defaultConverter">
                                                <f:selectItems value="#{orcamentoCabecalhoControll.condicoesPagamentos}"
                                                               var="obj" itemValue="#{obj}"
                                                               itemLabel="#{obj.nome}"/>
                                            </h:selectOneMenu>
                                        </h:panelGroup>

                                        <h:panelGroup layout="block" styleClass="col-xs-12 col-sm-3 col-md-3"
                                                      id="valo-pago">
                                            <div class="ui-inputgroup">


                                                <p:inputNumber id="valor-pago"
                                                               styleClass="input-valor-pagar"
                                                               value="#{orcamentoCabecalhoControll.valorPago}"/>
                                                <p:commandButton class="input-group-addon btn btn-lg btn-primary"
                                                                 action="#{orcamentoCabecalhoControll.lancaPagamento}"
                                                                 process="@this,:formCentro:tab-view-orcamento:tipo-pagamento"
                                                                 update="formCentro:growl,:formCentro:tab-view-orcamento:valo-pago,:formCentro:tab-view-orcamento:pagamentos"
                                                                 disabled="#{orcamentoCabecalhoControll.podeLancaPagamento}"
                                                                 id="botao-confirma-pagamento"
                                                                 icon="fa fa-plus">

                                                </p:commandButton>

                                            </div>
                                        </h:panelGroup>

                                    </h:panelGroup>

                                    <p:dataTable id="pagamentos" var="obj" reflow="true"
                                                 value="#{orcamentoCabecalhoControll.objeto.listaFormaPagamento}">

                                        <p:column headerText="Forma de pagamento">
                                            <h:outputText value="#{obj.tipoPagamento.descricao}"/>
                                        </p:column>

                                        <p:column headerText="Valor" styleClass="text-right">
                                            <h:outputText value="#{obj.valor}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </p:column>
                                        <p:column headerText="">
                                            <p:commandButton
                                                    icon="fa fa-remove"
                                                    process="@this,pagamentos"
                                                    update="formCentro:growl,:formCentro:tab-view-orcamento:valo-pago,:formCentro:tab-view-orcamento:pagamentos"
                                                    action="#{orcamentoCabecalhoControll.excluirPagamento}"

                                            >
                                                <f:setPropertyActionListener value="#{obj}"
                                                                             target="#{orcamentoCabecalhoControll.formaPagamentoSelecionado}"/>
                                            </p:commandButton>

                                        </p:column>

                                    </p:dataTable>
                                </p:tab>

                            </p:tabView>


                        </div>
                    </div>
                </div>

                <div class="ibox-footer">
                    <h:panelGroup layout="block" rendered="#{not empty orcamentoCabecalhoControll.objeto}">


                        <div class="row">
                            <div class="col-xs-6 col-lg-6 text-center">
                                <h:panelGroup layout="block" class="btn-group"
                                              rendered="#{ orcamentoCabecalhoControll.objeto.situacao ne 'F' and not orcamentoCabecalhoControll.objeto.situacao ne 'C'}">

                                    <p:commandButton value="Salvar"
                                                     id="btnSalvar"
                                                     rendered="#{empty orcamentoCabecalhoControll.objeto.id}"
                                                     action="#{orcamentoCabecalhoControll.salvar()}"
                                                     disabled="#{!orcamentoCabecalhoControll.podeInserir()}"
                                                     process="@this,:formCentro:tab-view-orcamento:form-dados-pripais"
                                                     update=":formCentro:growl,:formCentro:outputPanelDetalhe,navegacao,:formCentro:mensagem">

                                    </p:commandButton>


                                    <p:splitButton value="Salvar"
                                                   rendered="#{not empty orcamentoCabecalhoControll.objeto.id and
                                                       orcamentoCabecalhoControll.objeto.situacao ne 'F'}"
                                                   actionListener="#{orcamentoCabecalhoControll.salvar}"
                                                   icon="ui-icon-disk">

                                        <p:menuitem value="Aprovar"
                                                    actionListener="#{orcamentoCabecalhoControll.aprovarPedido}"
                                                    process="@this,:formCentro:tab-view-orcamento:form-dados-pripais"
                                                    update=":formCentro:growl,formCentro:mensagem,:formCentro:outputPanelDetalhe,:formCentro:outputPanelGrid"
                                                    rendered="#{orcamentoCabecalhoControll.objeto.tipo eq 'P' and orcamentoCabecalhoControll.objeto.situacao eq 'P'}"
                                                    icon="ui-icon-arrowrefresh-1-w"/>

                                        <p:menuitem value="Faturar"
                                                    actionListener="#{orcamentoCabecalhoControll.gerarVenda}"
                                                    process="@this,:formCentro:tab-view-orcamento:form-dados-pripais"
                                                    update=":formCentro:growl,formCentro:mensagem,:formCentro:outputPanelDetalhe,:formCentro:outputPanelGrid"
                                                    rendered="#{orcamentoCabecalhoControll.objeto.tipo eq 'P' and (orcamentoCabecalhoControll.objeto.situacao eq 'A'
                                                         or orcamentoCabecalhoControll.objeto.situacao eq 'P')}"
                                                    icon="ui-icon-arrowrefresh-1-w"/>

                                    </p:splitButton>


                                </h:panelGroup>

                            </div>
                            <div class="#{orcamentoCabecalhoControll.objeto.situacao eq 'A'} ? 'col-xs-12 col-lg-12' : 'col-xs-6 col-lg-6'">
                                <h:commandButton value="Cancelar" styleClass="btn btn-default center-block"
                                                 actionListener="#{orcamentoCabecalhoControll.voltar()}"
                                >
                                    <p:ajax update=":formCentro:outputPanelDetalhe,:formCentro:outputPanelGrid,navegacao,:formCentro:mensagem"
                                            process="@this"/>
                                </h:commandButton>
                            </div>
                        </div>


                    </h:panelGroup>
                </div>

            </h:panelGroup>

        </h:panelGroup>
    </h:panelGroup>

</ui:composition>
