<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:erp="http://java.sun.com/jsf/composite/components">


    <h:panelGroup layout="block" id="outputPanelDetalhe">
        <h:panelGroup layout="block" rendered="#{!vendaCabecalhoControll.telaGrid}">
            <h:panelGroup layout="block" id="panelCentroDetalhe">
                <div class="ibox-content">

                    <h:panelGroup layout="block" id="panel-valores" styleClass="row">
                        <div class="col-lg-4 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-gray">
                                <div class="inner">
                                    <h3>R$
                                        <span>
                                            <h:outputText value="#{vendaCabecalhoControll.objeto.valorTotal}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </span>
                                    </h3>

                                    <p>Valor Total</p>
                                </div>
                                <div class="icon" style="top: 0px">
                                    <i class="fa  fa-money"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-gray">
                                <div class="inner">
                                    <h3>R$
                                        <span>
                                            <h:outputText value="#{vendaCabecalhoControll.objeto.valorSubtotal}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </span>
                                    </h3>

                                    <p>Valor dos Produtos</p>
                                </div>
                                <div class="icon" style="top: 0px">
                                    <i class="fa fa-shopping-cart"></i>

                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-xs-6">
                            <!-- small box -->
                            <div class="small-box bg-gray">
                                <div class="inner">
                                    <h3>
                                        R$
                                        <span>
                                            <h:outputText value="#{vendaCabecalhoControll.objeto.valorDesconto}">
                                                <f:convertNumber pattern="#,##0.00"/>
                                            </h:outputText>
                                        </span>
                                        <p:commandLink styleClass="btn btn-link"
                                                       title="Aplicar desconto no valor total da venda"
                                                       update=":formOutrasTelas5:panelOutrasTelas5"
                                                       disabled="#{vendaCabecalhoControll.objeto.valorTotal.signum() eq 0}"
                                                       oncomplete="PF('dialogOutrasTelas5').show()">
                                            <i class="fa fa-pencil fa-2x" aria-hidden="true"></i>
                                        </p:commandLink>

                                        <p:commandLink styleClass="btn btn-link"
                                                       title="Remover Desconto"
                                                       action="#{vendaCabecalhoControll.removerDesconto}"
                                                       process="@this"
                                                       update=":formCentro:growl,:formCentro:panel-valores,:formCentro:dataTableVendaDetalhe"
                                                       rendered="#{vendaCabecalhoControll.objeto.valorDesconto.signum() ne 0}">
                                            <i class="fa fa-ban fa-2x" aria-hidden="true"></i>
                                        </p:commandLink>
                                    </h3>

                                    <p>Valor do Desconto</p>

                                </div>
                                <div class="icon" style="top: 0px">
                                    <i class="fa fa-percent" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>

                    </h:panelGroup>

                    <div class="row">
                        <div class="col-xs-12 col-sm-4 col-md-4">
                            <p:outputLabel value="Cliente" for="cliente"/>
                            <div class="field-action">
                                <p:autoComplete id="cliente"
                                                value="#{vendaCabecalhoControll.pessoaCliente}"
                                                completeMethod="#{vendaCabecalhoControll.getListaCliente}"
                                                var="objeto" itemLabel="#{objeto.nome}" itemValue="#{objeto}"
                                                queryDelay="500"
                                                style="width: 100%"
                                                converter="defaultConverter" forceSelection="true"
                                                minQueryLength="3" maxResults="10" required="true"
                                                emptyMessage="Nenhum registro encontrado">>
                                    <p:ajax event="itemSelect"
                                            listener="#{vendaCabecalhoControll.definirEnderecoEntrega}"/>

                                </p:autoComplete>
                                <div class="field-action__icon">
                                    <p:commandLink title="Add novo cliente" style="font-size: 20px;color: #00acac"
                                                   action="#{CadastroRapidoClienteControll.abrirDialog}"
                                                   process="@this" update="@none"
                                    >
                                        <p:ajax event="dialogReturn"
                                                listener="#{vendaCabecalhoControll.clienteSelecionado}"
                                                process="@this" update="cliente"/>
                                        <i class="fa fa-plus-circle"></i>
                                    </p:commandLink>
                                </div>


                            </div>

                        </div>

                        <erp:autoComplete styleClass="col-xs-12 col-sm-4 col-md-4"
                                          label="Vendedor"
                                          itemLabel="#{objeto.nome}"
                                          controller="#{vendaCabecalhoControll}"
                                          completeMethod="getListaVendedor"
                                          nomeAtributo="#{vendaCabecalhoControll.objeto.vendedor}"
                                          idComponente="vendaCabecalhoVendedor">
                            <p:ajax event="itemSelecionado"
                                    listener="#{vendaCabecalhoControll.definirTaxaComissao}"
                                    update="formOutrasTelas:campoValor:valorUnitario"/>

                        </erp:autoComplete>

                        <erp:autoComplete styleClass="col-xs-12 col-sm-4 col-md-4"
                                          label="Condicoes Pagamento"
                                          itemLabel="#{objeto.nome}"
                                          controller="#{vendaCabecalhoControll}"
                                          completeMethod="getListaVendaCondicoesPagamento"
                                          nomeAtributo="#{vendaCabecalhoControll.objeto.condicoesPagamento}"
                                          idComponente="vendaCabecalhoVendaCondicoesPagamento"
                        />

                    </div>
                    <div class="row">
                        <erp:campoInteiro styleClass="col-xs-12 col-sm-3 col-md-3"
                                          idComponente="vendaCabecalhoNumeroFatura"
                                          label="Numero Fatura"
                                          nomeAtributo="#{vendaCabecalhoControll.objeto.numeroFatura}"
                                          somenteLeitura="true"/>
                        <erp:campoData styleClass="col-xs-12 col-sm-3 col-md-3"
                                       idComponente="vendaCabecalhoDataVenda" label="Data Venda"
                                       nomeAtributo="#{vendaCabecalhoControll.objeto.dataVenda}"
                                       desabilitado="true"/>
                        <erp:campoData styleClass="col-xs-12 col-sm-3 col-md-3"
                                       idComponente="vendaCabecalhoDataSaida" label="Data Saida"
                                       nomeAtributo="#{vendaCabecalhoControll.objeto.dataSaida}"
                                       desabilitado="true"/>
                        <erp:campoMascara styleClass="col-xs-12 col-sm-3 col-md-3"
                                          idComponente="vendaCabecalhoHoraSaida" label="Hora Saida"
                                          nomeAtributo="#{vendaCabecalhoControll.objeto.horaSaida}"
                                          mascara="99:99:99"
                        />
                    </div>
                    <h:panelGroup class="row" layout="block"
                                  id="lista-empresa"
                                  rendered="#{vendaCabecalhoControll.listaEmpresas.size() gt 1}">


                        <erp:campoSelectConverter idComponente="empresa"
                                                  labelItens="#{obj.razaoSocial}"
                                                  id="emp"
                                                  nomeAtributo="#{vendaCabecalhoControll.objeto.empresa}"
                                                  itens="#{vendaCabecalhoControll.listaEmpresas}"
                                                  desabilitado="#{vendaCabecalhoControll.objeto.listaVendaDetalhe.size() gt 0}"
                                                  styleClass="col-xs-12 col-sm-3 col-md-3"
                                                  label="Empresa"/>
                    </h:panelGroup>
                    <div class="row">
                        <erp:campoAreaTexto styleClass="col-xs-12 col-sm-12 col-md-12"
                                            idComponente="vendaCabecalhoObservacao" label="Observacao"
                                            nomeAtributo="#{vendaCabecalhoControll.objeto.observacao}"/>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <erp:separador label="Produtos"/>
                            <div class="row">
                                <div class="col-md-12">
                                    <h:commandLink title="Novo" class="btn btn-default"
                                                   actionListener="#{vendaCabecalhoControll.incluirVendaDetalhe}"
                                                   type="button"
                                    >
                                        <p:resetInput target=":formOutrasTelas"/>
                                        <i class="glyphicon glyphicon-plus"/>
                                        <p:ajax update=":formOutrasTelas:panelVendaDetalhe,dataTableVendaDetalhe"
                                                oncomplete="PF('dialogVendaDetalhe').show()"
                                                process="@this,:formCentro:emp:empresa"/>
                                    </h:commandLink>
                                </div>
                            </div>
                            <p:dataTable id="dataTableVendaDetalhe" var="obj"
                                         value="#{vendaCabecalhoControll.objeto.listaVendaDetalhe}"
                                         paginator="true" rows="10" rowsPerPageTemplate="5,10,15,20"
                                         reflow="true"
                                         rowIndexVar="index" rowKey="index" paginatorPosition="bottom">

                                <p:column headerText="Produto">
                                    <h:outputLabel value="#{obj.produto.nome}"/>
                                </p:column>
                                <p:column headerText="Quantidade" styleClass="coluna-quantidade" width="120">
                                    <h:outputLabel value="#{obj.quantidade}">
                                        <f:convertNumber pattern="0.000"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Valor UN" class="coluna-monetaria" width="100">
                                    <h:outputLabel value="#{obj.valorUnitario}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Subtotal" class="coluna-monetaria" width="115">
                                    <h:outputLabel value="#{obj.valorSubtotal}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="DESC." class="coluna-monetaria" width="100">
                                    <h:outputLabel value="#{obj.valorDesconto}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Valor Total" class="coluna-monetaria" width="150">
                                    <h:outputLabel value="#{obj.valorTotal}">
                                        <f:convertNumber pattern="#,##0.00"/>
                                    </h:outputLabel>
                                </p:column>
                                <p:column headerText="Ações" width="120">
                                    <p:commandLink title="Alterar"
                                                   action="#{vendaCabecalhoControll.alterarVendaDetalhe}"
                                                   class=" btn btn-default"
                                                   oncomplete="PF('dialogVendaDetalhe').show()"
                                                   update="dataTableVendaDetalhe,:formOutrasTelas:panelVendaDetalhe"
                                    >
                                        <i class="fa fa-file-text-o"></i>
                                        <f:setPropertyActionListener value="#{obj}"
                                                                     target="#{vendaCabecalhoControll.vendaDetalheSelecionado}"/>
                                    </p:commandLink>
                                    &nbsp;
                                    <p:commandLink title="Excluir"
                                                   action="#{vendaCabecalhoControll.excluirVendaDetalhe}"
                                                   style="position: relative; right: 7px"
                                                   update=":formCentro:growl,dataTableVendaDetalhe,:formCentro:outputPanelDetalhe"
                                                   process="dataTableVendaDetalhe"
                                                   oncomplete="atualizarMsg();"
                                                   class="btn btn-default"
                                    >
                                        <i class="fa fa-times"></i>
                                        <p:confirm header="Confirmar" message="Deseja excluir ?"/>

                                        <f:setPropertyActionListener value="#{obj}"
                                                                     target="#{vendaCabecalhoControll.vendaDetalheSelecionado}"/>
                                    </p:commandLink>
                                </p:column>
                            </p:dataTable>
                        </div>
                    </div>
                </div>
                <div class="ibox-footer">

                    <h:panelGroup layout="block" rendered="#{not empty vendaCabecalhoControll.objeto}">
                        <div class="row">
                            <div class="col-xs-6 col-lg-6 text-center">
                                <h:panelGroup layout="block" class="btn-group"
                                              id="grupo-botao"
                                              rendered="#{!vendaCabecalhoControll.objeto.faturado and !vendaCabecalhoControll.objeto.cancelado}">
                                    <p:commandButton value="Salvar"
                                                     id="btnSalvar"
                                                     rendered="#{empty vendaCabecalhoControll.objeto.id}"
                                                     action="#{vendaCabecalhoControll.salvar()}"
                                                     disabled="#{!vendaCabecalhoControll.podeInserir()}"
                                                     process="@form"
                                                     oncomplete="addClass()"
                                                     update=":formCentro:growl,:formCentro:outputPanelGrid,:formCentro:outputPanelDetalhe,navegacao,:formCentro:mensagem">

                                    </p:commandButton>


                                    <p:splitButton value="Salvar"
                                                   rendered="#{not empty vendaCabecalhoControll.objeto.id}"
                                                   action="#{vendaCabecalhoControll.salvar()}"
                                                   update=":formCentro:growl,:formCentro:outputPanelGrid,:formCentro:outputPanelDetalhe,navegacao,:formCentro:mensagem"
                                                   icon="ui-icon-disk">
                                        <p:menuitem value="Encerrar"
                                                    action="#{vendaCabecalhoControll.encerrarVenda}"
                                                    update=":formCentro:growl,formCentro:mensagem,:formCentro:outputPanelGrid,:formCentro:outputPanelDetalhe"
                                                    rendered="#{!vendaCabecalhoControll.objeto.encerrado}"
                                                    icon="ui-icon-arrowrefresh-1-w"/>

                                        <p:menuitem value="Faturar"
                                                    action="#{vendaCabecalhoControll.faturarVenda}"
                                                    update=":formCentro:growl,formCentro:mensagem,:formCentro:outputPanelGrid,:formCentro:outputPanelDetalhe"
                                                    rendered="#{!vendaCabecalhoControll.objeto.faturado}"
                                                    icon="ui-icon-arrowrefresh-1-w"/>

                                    </p:splitButton>


                                </h:panelGroup>

                            </div>
                            <div class="#{vendaCabecalhoControll.objeto.faturado} ? 'col-xs-12 col-lg-12' : 'col-xs-6 col-lg-6'">
                                <h:commandButton value="Cancelar" styleClass="btn btn-default center-block"
                                                 actionListener="#{vendaCabecalhoControll.voltar()}"
                                >
                                    <p:ajax update=":formCentro:outputPanelGrid,:formCentro:outputPanelDetalhe,navegacao,:formCentro:mensagem"
                                            process="@this"/>
                                </h:commandButton>
                            </div>
                        </div>

                    </h:panelGroup>

                </div>
            </h:panelGroup>
        </h:panelGroup>
    </h:panelGroup>

</ui:composition>
